# ==============================================
# GitHub Actions Workflow: è‡ªåŠ¨å‘å¸ƒ Lunatv æ–‡ä»¶
# ==============================================
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1ï¸âƒ£ æ–‡ä»¶å¤¹ä½ç½®ï¼š.github/workflows/release-lunatv.yml
# 2ï¸âƒ£ è§¦å‘æ¡ä»¶ï¼š
#    - paths:
#        - 'Lunatv/**'   # ğŸ‘ˆ ç›‘å¬ç›®å½•ï¼Œå¯ä¿®æ”¹ä¸ºå…¶ä»–ç›®å½•ï¼Œå¦‚ 'Movies/**'
#    - branches:
#        - main          # åªç›‘å¬ main åˆ†æ”¯
# 3ï¸âƒ£ å˜é‡è¯´æ˜ï¼ˆéœ€æ ¹æ®ç›®å½•ä¿®æ”¹ï¼‰ï¼š
#    - DIR: æ–‡ä»¶å¤¹åç§°ï¼Œä¾‹å¦‚ Lunatvã€Moviesã€Configs
#    - TAG: Release tagï¼Œä¸åŒç›®å½•å¿…é¡»ä¸åŒï¼Œå¦‚ latest-lunatvã€latest-movies
#    - Release åç§°: name: "${DIR} Auto Release"ï¼Œå¯æ ¹æ®éœ€æ±‚ä¿®æ”¹
# 4ï¸âƒ£ åŠŸèƒ½ï¼š
#    - è‡ªåŠ¨ç”Ÿæˆ index.jsonï¼ŒåŒ…å«æ¯ä¸ªæ–‡ä»¶çš„å¤§å°ã€Git æœ€åæäº¤æ—¶é—´ã€Release ä¸‹è½½é“¾æ¥ã€Raw é“¾æ¥
#    - è‡ªåŠ¨ç”Ÿæˆ Release bodyï¼Œæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶åŠè¯¦ç»†ä¿¡æ¯
#    - ä¿è¯æ–‡ä»¶æœ€åæ›´æ–°æ—¶é—´æ¥æºäº Git æäº¤ï¼Œè€Œä¸æ˜¯ workflow æ‰§è¡Œæ—¶é—´
#    - è‡ªåŠ¨æäº¤ index.jsonï¼Œä¿æŒ Raw é“¾æ¥å¯è®¿é—®
# 5ï¸âƒ£ æ·»åŠ æ–°ç›®å½•ï¼š
#    - å¤åˆ¶æœ¬ workflow æ–‡ä»¶
#    - ä¿®æ”¹ pathsã€DIRã€TAGã€Release åç§°å³å¯
# ==============================================

name: Auto Release Lunatv Files

on:
  push:
    paths:
      - 'Lunatv/**'   # ğŸ‘ˆ ä¿®æ”¹ä¸ºå¯¹åº”ç›®å½•
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1ï¸âƒ£ æ‹‰å–å®Œæ•´ Git å†å²
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # å¿…é¡»ä¸º 0ï¼Œå¦åˆ™æ— æ³•è·å– Git å†å²ï¼Œæ›´æ–°æ—¶é—´ä¸å‡†ç¡®

      # -------------------------------
      # 2ï¸âƒ£ ç”Ÿæˆ index.json å’Œ Release body
      # -------------------------------
      - name: Generate index.json and release body with Git dates
        run: |
          # -------------------------------
          # ğŸ‘‡ ä»¥ä¸‹å˜é‡éœ€é’ˆå¯¹ä¸åŒç›®å½•ä¿®æ”¹
          DIR="Lunatv"               # æ–‡ä»¶å¤¹åç§°
          REPO="mebaddy/TV"          # ä»“åº“å…¨å
          TAG="latest-lunatv"        # Release tagï¼ˆä¸åŒç›®å½•å¿…é¡»ä¸åŒï¼‰
          BRANCH="main"              # åˆ†æ”¯å
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          RAW_BASE="https://raw.githubusercontent.com/${REPO}/${BRANCH}"
          BODY_FILE="release_body.txt"
          # -------------------------------

          mkdir -p "$DIR"

          # åˆå§‹åŒ– index.json å’Œ release body
          echo "[" > $DIR/index.json
          echo "### ğŸ“¦ æ–‡ä»¶æ›´æ–°æ¸…å•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰" > $BODY_FILE
          echo "" >> $BODY_FILE

          first=true
          for f in $(find $DIR -type f ! -name "index.json"); do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> $DIR/index.json
            fi

            fname=$(basename "$f")
            size=$(stat -c%s "$f")

            # è·å– Git æœ€åæäº¤æ—¶é—´
            git_time=$(git log -1 --format="%cI" -- "$f")
            if [ -z "$git_time" ]; then
              git_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            fi

            dlink="${BASE_URL}/${fname}"
            rawlink="${RAW_BASE}/${f}"

            # å†™å…¥ index.json
            echo "  {\"name\": \"${fname}\", \"path\": \"${f}\", \"size\": ${size}, \"updated_at\": \"${git_time}\", \"download_url\": \"${dlink}\", \"raw_url\": \"${rawlink}\"}" >> $DIR/index.json

            # å†™å…¥ Release body
            echo "- **${fname}**" >> $BODY_FILE
            echo "  - å¤§å°ï¼š${size} å­—èŠ‚" >> $BODY_FILE
            echo "  - æ›´æ–°æ—¶é—´ï¼š${git_time}" >> $BODY_FILE
            echo "  - ğŸ“¥ [Release ä¸‹è½½é“¾æ¥](${dlink})" >> $BODY_FILE
            echo "  - ğŸŒ [Raw åœ¨çº¿è®¿é—®](${rawlink})" >> $BODY_FILE
            echo "" >> $BODY_FILE
          done

          echo "]" >> $DIR/index.json
          echo "" >> $BODY_FILE
          echo "ğŸ§¾ è‡ªåŠ¨ç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶ï¼š[index.json](${BASE_URL}/index.json)" >> $BODY_FILE

      - name: Show generated index.json
        run: cat $DIR/index.json

      - name: Show release body preview
        run: cat release_body.txt

      # -------------------------------
      # 3ï¸âƒ£ è‡ªåŠ¨æäº¤ index.json
      # -------------------------------
      - name: Commit index.json to repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $DIR/index.json
          if git diff --cached --quiet; then
            echo "No changes in index.json, skipping commit."
          else
            git commit -m "Auto update index.json [skip ci]"
            git push origin main
          fi

      # -------------------------------
      # 4ï¸âƒ£ å‘å¸ƒæˆ–æ›´æ–° Release
      # -------------------------------
      - name: Publish release with details
        uses: softprops/action-gh-release@v2
        with:
          tag_name: $TAG                  # ğŸ‘ˆ ç›®å½•ç‹¬ç«‹ tag
          name: "${DIR} Auto Release"     # ğŸ‘ˆ Release åç§°
          body_path: release_body.txt
          files: $DIR/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

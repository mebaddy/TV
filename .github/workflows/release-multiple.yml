# ==============================================
# GitHub Actions Workflow: Ëá™Âä®ÂèëÂ∏ÉÁõÆÂΩïÊñá‰ª∂
# ==============================================
#
# ‰ΩøÁî®ÊñπÊ≥ïÔºö
# 1Ô∏è‚É£ Êñá‰ª∂Â§π‰ΩçÁΩÆÔºö.github/workflows/release-lunatv.yml
# 2Ô∏è‚É£ ‰øÆÊîπ‰ª•‰∏ãÂèòÈáèÂç≥ÂèØÈÄÇÈÖç‰∏çÂêåÁõÆÂΩïÊàñÂçïÊñá‰ª∂ÂèëÂ∏ÉÔºö
#    - WATCH_PATH: ÁõëÂê¨ÁöÑÊñá‰ª∂ÊàñÁõÆÂΩïË∑ØÂæÑÔºåÂ¶Ç 'Lunatv/**' Êàñ 'Lunatv/url.json'
#    - DIR: Êñá‰ª∂Â§πÂêçÁß∞ÊàñÊñá‰ª∂ÊâÄÂú®Êñá‰ª∂Â§πÂêçÁß∞Ôºå‰æãÂ¶Ç Lunatv„ÄÅMovies„ÄÅConfigs
#    - TAG: Release tagÔºå‰∏çÂêåÁõÆÂΩïÂøÖÈ°ª‰∏çÂêåÔºåÂ¶Ç latest-lunatv„ÄÅlatest-movies
#    - RELEASE_NAME: Release È°µÈù¢ÊòæÁ§∫ÁöÑÂêçÁß∞Ôºå‰æãÂ¶Ç "Lunatv Auto Release"
# 3Ô∏è‚É£ Ê∑ªÂä†Êñ∞ÁõÆÂΩïÔºö
#    - Â§çÂà∂Êú¨ workflow Êñá‰ª∂
#    - ‰øÆÊîπ‰∏äËø∞ÂèòÈáèÂç≥ÂèØ
# ==============================================

name: Auto Release Files

# -------------------------------
# 1Ô∏è‚É£ Áªü‰∏ÄÈÖçÁΩÆÂèòÈáè
# -------------------------------
env:
  WATCH_PATH: 'Lunatv/**'         # üëà ÁõëÂê¨ÁõÆÂΩïÊàñÊñá‰ª∂Ë∑ØÂæÑ
  DIR: 'Lunatv'                   # üëà Êñá‰ª∂Â§πÂêçÁß∞ÊàñÊñá‰ª∂ÊâÄÂú®ÁõÆÂΩï
  TAG: 'latest-lunatv'            # üëà Release tagÔºàÂøÖÈ°ªÂîØ‰∏ÄÔºâ
  RELEASE_NAME: 'Lunatv Auto Release'   # üëà Release ÊòæÁ§∫ÂêçÁß∞
  REPO: 'mebaddy/TV'              # üëà ‰ªìÂ∫ìÂÖ®Âêç
  BRANCH: 'main'                  # üëà ÂàÜÊîØÂêç

on:
  push:
    paths:
      - ${{ env.WATCH_PATH }}
    branches:
      - ${{ env.BRANCH }}

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 2Ô∏è‚É£ ÊãâÂèñÂÆåÊï¥ Git ÂéÜÂè≤
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # 3Ô∏è‚É£ ÁîüÊàê index.json Âíå Release body
      # -------------------------------
      - name: Generate index.json and release body
        run: |
          mkdir -p "${DIR}"

          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          RAW_BASE="https://raw.githubusercontent.com/${REPO}/${BRANCH}"
          BODY_FILE="release_body.txt"

          # ÂàùÂßãÂåñ index.json Âíå release body
          echo "[" > $DIR/index.json
          echo "### üì¶ Êñá‰ª∂Êõ¥Êñ∞Ê∏ÖÂçïÔºàËá™Âä®ÁîüÊàêÔºâ" > $BODY_FILE
          echo "" >> $BODY_FILE

          first=true
          for f in $(find $DIR -type f ! -name "index.json"); do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> $DIR/index.json
            fi

            fname=$(basename "$f")
            size=$(stat -c%s "$f")

            # Ëé∑Âèñ Git ÊúÄÂêéÊèê‰∫§Êó∂Èó¥
            git_time=$(git log -1 --format="%cI" -- "$f")
            if [ -z "$git_time" ]; then
              git_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            fi

            dlink="${BASE_URL}/${fname}"
            rawlink="${RAW_BASE}/${f}"

            # ÂÜôÂÖ• index.json
            echo "  {\"name\": \"${fname}\", \"path\": \"${f}\", \"size\": ${size}, \"updated_at\": \"${git_time}\", \"download_url\": \"${dlink}\", \"raw_url\": \"${rawlink}\"}" >> $DIR/index.json

            # ÂÜôÂÖ• Release body
            echo "- **${fname}**" >> $BODY_FILE
            echo "  - Â§ßÂ∞èÔºö${size} Â≠óËäÇ" >> $BODY_FILE
            echo "  - Êõ¥Êñ∞Êó∂Èó¥Ôºö${git_time}" >> $BODY_FILE
            echo "  - üì• [Release ‰∏ãËΩΩÈìæÊé•](${dlink})" >> $BODY_FILE
            echo "  - üåê [Raw Âú®Á∫øËÆøÈóÆ](${rawlink})" >> $BODY_FILE
            echo "" >> $BODY_FILE
          done

          echo "]" >> $DIR/index.json
          echo "" >> $BODY_FILE
          echo "üßæ Ëá™Âä®ÁîüÊàêÁöÑÁ¥¢ÂºïÊñá‰ª∂Ôºö[index.json](${BASE_URL}/index.json)" >> $BODY_FILE

      - name: Show generated index.json
        run: cat $DIR/index.json

      - name: Show release body preview
        run: cat release_body.txt

      # -------------------------------
      # 4Ô∏è‚É£ Ëá™Âä®Êèê‰∫§ index.json
      # -------------------------------
      - name: Commit index.json to repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $DIR/index.json
          if git diff --cached --quiet; then
            echo "No changes in index.json, skipping commit."
          else
            git commit -m "Auto update index.json [skip ci]"
            git push origin $BRANCH
          fi

      # -------------------------------
      # 5Ô∏è‚É£ ÂèëÂ∏ÉÊàñÊõ¥Êñ∞ Release
      # -------------------------------
      - name: Publish release with details
        uses: softprops/action-gh-release@v2
        with:
          tag_name: $TAG
          name: $RELEASE_NAME
          body_path: release_body.txt
          files: $DIR/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Auto Release Files (Clean Recreate)

on:
  push:
    # -------------------------------
    # âš ï¸ å¦‚æœä½ ä¿®æ”¹äº† FOLDERï¼Œä¹Ÿè¯·åŒæ­¥ä¿®æ”¹ä¸‹é¢è·¯å¾„
    # -------------------------------
    paths:
      - 'Lunatv/**'   # ç›‘å¬æ–‡ä»¶å¤¹è·¯å¾„ï¼Œæ”¹ FOLDER æ—¶éœ€åŒæ­¥ä¿®æ”¹
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 0ï¸âƒ£ é…ç½®å˜é‡ï¼ˆâš¡ï¸ è¿™é‡Œæ˜¯ä½ æœ€å¸¸ä¿®æ”¹çš„åœ°æ–¹ï¼‰
      # -------------------------------
      - name: Set environment variables
        run: |
          # =======================================
          # âš¡ï¸ âš¡ï¸ âš¡ï¸ ä¿®æ”¹è¿™é‡Œå³å¯æ§åˆ¶æ•´ä¸ª workflow âš¡ï¸ âš¡ï¸ âš¡ï¸
          # =======================================
          # ä»“åº“åè‡ªåŠ¨è·å–ï¼Œæ— éœ€ä¿®æ”¹
          echo "REPO=${GITHUB_REPOSITORY}" >> $GITHUB_ENV
          # å‘å¸ƒçš„æ–‡ä»¶å¤¹ï¼ˆä¿®æ”¹ä¸ºä½ æƒ³å‘å¸ƒçš„æ–‡ä»¶å¤¹åï¼‰
          echo "FOLDER=Lunatv" >> $GITHUB_ENV
          # Release tagï¼ŒåŒæ—¶ä¹Ÿæ˜¯ Release åç§°
          echo "TAG=latest-files" >> $GITHUB_ENV
          # åˆ†æ”¯åï¼ˆRaw é“¾æ¥å’Œ git log ç”¨ï¼‰
          echo "BRANCH=main" >> $GITHUB_ENV

      # -------------------------------
      # 1ï¸âƒ£ æ‹‰å–å®Œæ•´å†å²ï¼Œä¿è¯ git log è·å–æäº¤æ—¶é—´
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # 2ï¸âƒ£ å®‰è£… GitHub CLIï¼ˆç”¨äºåˆ é™¤ Release å’Œ tagï¼‰
      # -------------------------------
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      # -------------------------------
      # 3ï¸âƒ£ åˆ é™¤å·²æœ‰ Release å’Œ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      # -------------------------------
      - name: Delete existing release and tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ é™¤ Release
          if gh release view $TAG 2>/dev/null; then
            echo "Deleting existing release $TAG..."
            gh release delete $TAG --yes
          fi
          # åˆ é™¤ Git tag
          if git rev-parse $TAG >/dev/null 2>&1; then
            echo "Deleting local and remote tag $TAG..."
            git tag -d $TAG
            git push origin :refs/tags/$TAG
          fi

      # -------------------------------
      # 4ï¸âƒ£ ç”Ÿæˆ index.json å’Œ Release body
      # -------------------------------
      - name: Generate index.json and release body with Git dates
        run: |
          mkdir -p $FOLDER
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          RAW_BASE="https://raw.githubusercontent.com/${REPO}/${BRANCH}"
          BODY_FILE="release_body.txt"

          echo "[" > $FOLDER/index.json
          echo "### ğŸ“¦ æ–‡ä»¶æ›´æ–°æ¸…å•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰" > $BODY_FILE
          echo "" >> $BODY_FILE

          first=true
          # éå†æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ˆæ’é™¤ index.jsonï¼‰
          for f in $(find $FOLDER -type f ! -name "index.json"); do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> $FOLDER/index.json
            fi

            fname=$(basename "$f")
            size=$(stat -c%s "$f")

            # è·å–æœ€åæäº¤æ—¶é—´
            git_time=$(git log -1 --format="%cI" -- "$f")
            if [ -z "$git_time" ]; then
              git_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            fi

            dlink="${BASE_URL}/${fname}"
            rawlink="${RAW_BASE}/${f}"

            # å†™å…¥ index.json
            echo "  {\"name\": \"${fname}\", \"path\": \"${f}\", \"size\": ${size}, \"updated_at\": \"${git_time}\", \"download_url\": \"${dlink}\", \"raw_url\": \"${rawlink}\"}" >> $FOLDER/index.json

            # å†™å…¥ Release body
            echo "- **${fname}**" >> $BODY_FILE
            echo "  - å¤§å°ï¼š${size} å­—èŠ‚" >> $BODY_FILE
            echo "  - æ›´æ–°æ—¶é—´ï¼š${git_time}" >> $BODY_FILE
            echo "  - ğŸ“¥ [Release ä¸‹è½½é“¾æ¥](${dlink})" >> $BODY_FILE
            echo "  - ğŸŒ [Raw åœ¨çº¿è®¿é—®](${rawlink})" >> $BODY_FILE
            echo "" >> $BODY_FILE
          done

          echo "]" >> $FOLDER/index.json
          echo "" >> $BODY_FILE
          echo "ğŸ§¾ è‡ªåŠ¨ç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶ï¼š[index.json](${BASE_URL}/index.json)" >> $BODY_FILE

      - name: Show generated index.json
        run: cat $FOLDER/index.json

      - name: Show release body preview
        run: cat release_body.txt

      # -------------------------------
      # 5ï¸âƒ£ è‡ªåŠ¨æäº¤ index.jsonï¼Œä¿è¯ Raw é“¾æ¥å¯è®¿é—®
      # -------------------------------
      - name: Commit index.json to repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $FOLDER/index.json
          if git diff --cached --quiet; then
            echo "No changes in index.json, skipping commit."
          else
            git commit -m "Auto update index.json [skip ci]"
            git push origin main
          fi

      # -------------------------------
      # 6ï¸âƒ£ åˆ›å»ºæ–°çš„ Release
      # -------------------------------
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}                  # Release åç§°ä¸ tag ç›¸åŒ
          body_path: release_body.txt
          files: ${{ env.FOLDER }}/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
